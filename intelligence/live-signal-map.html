<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Live Signal Map - Territory Intelligence</title>
      <link rel="stylesheet" href="../assets/dunsonator.css" />
      <link rel="stylesheet" href="../assets/glass-dark.css" />
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: #0a0e27; color: #fff; overflow: hidden; }
    #map-container { width: 100vw; height: 100vh; position: relative; }
    #globe { width: 100%; height: 100%; background: radial-gradient(circle at center, #1a2332 0%, #0a0e27 100%); }
    .hud { position: absolute; background: rgba(10,14,39,0.9); border: 1px solid rgba(0,160,251,0.3); border-radius: 8px; padding: 15px; font-size: 12px; }
    .hud-title { font-size: 10px; color: #00a0fb; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; font-weight: 700; }
    #ml-engine { top: 20px; left: 20px; width: 320px; }
    #signal-feed { top: 20px; right: 20px; width: 380px; max-height: 600px; overflow-y: auto; }
    #predictions { bottom: 20px; left: 20px; width: 400px; }
    #stats { bottom: 20px; right: 20px; width: 280px; }
    .signal-item { background: rgba(0,160,251,0.05); border-left: 3px solid; padding: 10px; margin-bottom: 8px; border-radius: 4px; animation: slideIn 0.3s; }
    .signal-item.critical { border-left-color: #f44336; }
    .signal-item.high { border-left-color: #ff9800; }
    .signal-item.medium { border-left-color: #00a0fb; }
    .signal-time { font-size: 10px; color: #888; margin-top: 4px; }
    .confidence { float: right; background: rgba(0,200,83,0.2); color: #00c853; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; }
    .pattern { background: rgba(255,152,0,0.1); padding: 8px; margin: 8px 0; border-radius: 4px; border-left: 3px solid #ff9800; }
    .prediction { background: rgba(0,160,251,0.1); padding: 8px; margin: 8px 0; border-radius: 4px; }
    .stat-row { display: flex; justify-content: space-between; margin: 6px 0; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .stat-label { color: #888; font-size: 11px; }
    .stat-value { color: #00a0fb; font-weight: 700; }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .live-indicator { width: 8px; height: 8px; background: #00c853; border-radius: 50%; display: inline-block; margin-right: 6px; animation: pulse 1.5s infinite; }
    .account-marker { position: absolute; width: 12px; height: 12px; background: #00a0fb; border-radius: 50%; box-shadow: 0 0 20px #00a0fb; cursor: pointer; transition: all 0.3s; }
    .account-marker:hover { transform: scale(1.5); }
    .signal-beam { position: absolute; height: 2px; background: linear-gradient(90deg, transparent, #00a0fb, transparent); animation: beamPulse 2s infinite; }
    @keyframes beamPulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
  </style>
</head>
<body>
  <div id="map-container">
    <div id="globe"></div>
            <svg id="airspace" style="position:absolute;width:100%;height:100%;top:0;left:0;pointer-events:none;">
            <!-- Aircraft will be dynamically created here -->
        </svg>
    
    <!-- ML Decision Engine HUD -->
    <div id="ml-engine" class="hud">
      <div class="hud-title"><span class="live-indicator"></span>ML DECISION ENGINE</div>
      <div id="ml-analysis"></div>
    </div>
    
    <!-- Live Signal Feed -->
    <div id="signal-feed" class="hud">
      <div class="hud-title"><span class="live-indicator"></span>LIVE SIGNAL INGESTION</div>
      <div id="signals"></div>
    </div>
    
    <!-- Predictions -->
    <div id="predictions" class="hud">
      <div class="hud-title">PREDICTIVE ANALYTICS</div>
      <div id="prediction-output"></div>
    </div>
    
    <!-- Stats -->
    <div id="stats" class="hud">
      <div class="hud-title">SYSTEM STATUS</div>
      <div id="stat-output"></div>
    </div>
  </div>
  
  <script>
    // Load data
    async function loadData() {
      const r = await fetch('./data/public_demo.json?ts=' + Date.now());
      return await r.json();
    }
    
    // ML Analysis Engine
    function analyzePatterns(data) {
      const alerts = data.alerts || [];
      const signals = data.intent_signals || [];
      
      // Pattern 1: Temporal Clustering
      const recentAlerts = alerts.filter(a => {
        const t = new Date(a.timestamp);
        const now = new Date();
        return (now - t) / 1000 / 60 / 60 < 6; // last 6 hours
      });
      
      // Pattern 2: Geographic Concentration  
      const bayAreaAccounts = ['Meta Platforms', 'Confluent', 'Snowflake', 'Databricks', 'Pure Storage', 'ServiceNow', 'Palo Alto Networks'];
      const bayAreaSignals = signals.filter(s => bayAreaAccounts.includes(s.account));
      
      // Pattern 3: Multi-source Validation
      const highConfidence = alerts.filter(a => a.confidence > 0.85);
      
      // Pattern 4: Buying Stage Clustering
      const decisionStage = signals.filter(s => s.stage === 'Decision');
      
      return {
        temporalCluster: recentAlerts.length,
        geoConcentration: (bayAreaSignals.length / signals.length * 100).toFixed(0),
        highConfAlerts: highConfidence.length,
        hotAccounts: decisionStage.length,
        criticalWindow: recentAlerts.filter(a => a.severity === 'critical').length
      };
    }
    
    // Render ML Analysis
    function renderMLEngine(patterns, data) {
      const html = `
        <div class="pattern">
          <strong>PATTERN: Temporal Clustering</strong><br>
          <span style="color:#00c853;">${patterns.temporalCluster} signals</span> detected in 6-hour window<br>
          <em>Interpretation: Synchronized market movement</em>
        </div>
        <div class="pattern">
          <strong>PATTERN: Geographic Density</strong><br>
          <span style="color:#00c853;">${patterns.geoConcentration}%</span> concentration in Bay Area<br>
          <em>Interpretation: Regional ecosystem trigger</em>
        </div>
        <div class="pattern">
          <strong>PATTERN: Multi-Source Validation</strong><br>
          <span style="color:#00c853;">${patterns.highConfAlerts}</span> alerts with 85%+ confidence<br>
          <em>Interpretation: Cross-validated intelligence</em>
        </div>
        <div class="pattern">
          <strong>DECISION: Critical Action Required</strong><br>
          <span style="color:#f44336;">${patterns.criticalWindow}</span> critical-severity signals<br>
          <span style="color:#ff9800;">${patterns.hotAccounts}</span> accounts in Decision stage<br>
          <em>Next: Initiate multi-threaded outreach immediately</em>
        </div>
      `;
      document.getElementById('ml-analysis').innerHTML = html;
    }
    
    // Render Live Signals
    function renderSignals(alerts) {
      const html = alerts.slice(0, 8).map(a => `
        <div class="signal-item ${a.severity}">
          <span class="confidence">${Math.round(a.confidence * 100)}%</span>
          <strong>${a.message.split(':')[0]}</strong><br>
          <span style="font-size:11px;">${a.message.split(':')[1]}</span>
          <div class="signal-time">${a.type} • ${a.source} • ${new Date(a.timestamp).toLocaleTimeString()}</div>
        </div>
      `).join('');
      document.getElementById('signals').innerHTML = html;
    }
    
    // Render Predictions
    function renderPredictions(signals) {
      const top3 = signals.slice(0, 3);
      const html = top3.map((s, i) => {
        const prob = Math.min(95, s.score + (i === 0 ? 10 : 0));
        return `
          <div class="prediction">
            <strong>${s.account}</strong><br>
            <div style="display:flex;justify-content:space-between;margin-top:4px;">
              <span style="color:#888;font-size:10px;">Close Probability</span>
              <span style="color:#00c853;font-weight:700;">${prob}%</span>
            </div>
            <div style="background:rgba(255,255,255,0.1);height:4px;margin-top:4px;border-radius:2px;">
              <div style="background:#00c853;height:100%;width:${prob}%;border-radius:2px;"></div>
            </div>
            <div style="font-size:10px;color:#888;margin-top:4px;">
              ${s.stage} • ${s.trend} • ${s.days_in_stage}d in stage
            </div>
          </div>
        `;
      }).join('');
      document.getElementById('prediction-output').innerHTML = html;
    }
    
    // Render Stats
    function renderStats(data) {
      const rts = data.real_time_signals || {};
      const html = `
        <div class="stat-row"><span class="stat-label">Active Signals</span><span class="stat-value">${data.alerts.length}</span></div>
        <div class="stat-row"><span class="stat-label">Total Processed</span><span class="stat-value">${rts.total_signals_processed || 0}</span></div>
        <div class="stat-row"><span class="stat-label">Press Releases</span><span class="stat-value">${rts.press_releases || 0}</span></div>
        <div class="stat-row"><span class="stat-label">Job Postings</span><span class="stat-value">${rts.job_postings_relevant || 0}</span></div>
        <div class="stat-row"><span class="stat-label">Patents Filed</span><span class="stat-value">${rts.patent_filings || 0}</span></div>
        <div class="stat-row"><span class="stat-label">Social Mentions</span><span class="stat-value">${rts.social_mentions || 0}</span></div>
        <div class="stat-row"><span class="stat-label">Last Scan</span><span class="stat-value class="pulse">${new Date().toLocaleTimeString()}</span></div>
      `;
      document.getElementById('stat-output').innerHTML = html;
    }
    
    // Main render
    async function render() {
      const data = await loadData();
      const patterns = analyzePatterns(data);
      
      
    // Create Stratospheric Aircraft Visualization
    const aircraftTypes = [
        {name: 'Boeing 777', type: 'widebody', size: 18},
        {name: 'Airbus A350', type: 'widebody', size: 17},
        {name: 'Boeing 787', type: 'widebody', size: 16},
        {name: 'Airbus A330', type: 'widebody', size: 15},
        {name: 'Boeing 737 MAX', type: 'narrowbody', size: 12},
        {name: 'Airbus A320neo', type: 'narrowbody', size: 11}
    ];

    function createAircraft() {
        const svg = document.getElementById('airspace');
        svg.innerHTML = ''; // Clear existing

        // Create 25-30 aircraft at various altitudes
        const numAircraft = 25 + Math.floor(Math.random() * 6);

        for(let i = 0; i < numAircraft; i++) {
            const aircraft = aircraftTypes[Math.floor(Math.random() * aircraftTypes.length)];
            
            // Altitude in stratosphere: 30,000 - 45,000 feet
            // Convert to visual representation: higher altitude = smaller size + higher position
            const altitude = 30000 + Math.random() * 15000;
            const altitudeFactor = (altitude - 30000) / 15000; // 0 to 1
            
            // Size scales with altitude (smaller at higher altitude)
            const visualSize = aircraft.size * (1.2 - altitudeFactor * 0.6);
            
            // Position: X across screen, Y based on altitude (higher = further up)
            const x = 5 + Math.random() * 90; // 5-95% across
            const y = 15 + (1 - altitudeFactor) * 70; // Higher altitude = lower Y value (top of screen)
            
            // Random heading
            const heading = Math.random() * 360;
            
            // Create aircraft group
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('transform', `translate(${x}%, ${y}%)`);
            
            // Create aircraft shape (simplified but recognizable)
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            
            if(aircraft.type === 'widebody') {
                // Wider fuselage, larger wings
                path.setAttribute('d', `
                    M 0,-${visualSize/2}
                    L ${visualSize*2},-${visualSize/3}
                    L ${visualSize*2.5},0
                    L ${visualSize*2},${visualSize/3}
                    L 0,${visualSize/2}
                    L -${visualSize*0.3},0
                    Z
                    M -${visualSize*0.5},-${visualSize}
                    L ${visualSize*0.5},-${visualSize/3}
                    L ${visualSize*0.5},${visualSize/3}
                    L -${visualSize*0.5},${visualSize}
                    Z
                `);
            } else {
                // Narrower fuselage, smaller wings
                path.setAttribute('d', `
                    M 0,-${visualSize/3}
                    L ${visualSize*2.2},-${visualSize/4}
                    L ${visualSize*2.5},0
                    L ${visualSize*2.2},${visualSize/4}
                    L 0,${visualSize/3}
                    L -${visualSize*0.2},0
                    Z
                    M -${visualSize*0.4},-${visualSize*0.8}
                    L ${visualSize*0.3},-${visualSize/4}
                    L ${visualSize*0.3},${visualSize/4}
                    L -${visualSize*0.4},${visualSize*0.8}
                    Z
                `);
            }
            
            path.setAttribute('fill', `rgba(0, 230, 255, ${0.6 + altitudeFactor * 0.4})`);
            path.setAttribute('stroke', `rgba(0, 255, 255, ${0.8 + altitudeFactor * 0.2})`);
            path.setAttribute('stroke-width', '0.5');
            path.setAttribute('transform', `rotate(${heading})`);
            path.setAttribute('filter', 'drop-shadow(0 0 3px rgba(0,230,255,0.8))');
            
            // Add contrail effect for higher aircraft
            if(altitudeFactor > 0.5) {
                const contrail = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                contrail.setAttribute('x1', '0');
                contrail.setAttribute('y1', '0');
                contrail.setAttribute('x2', `-${visualSize*3}`);
                contrail.setAttribute('y2', '0');
                contrail.setAttribute('stroke', `rgba(200, 240, 255, ${0.2 * altitudeFactor})`);
                contrail.setAttribute('stroke-width', visualSize/4);
                contrail.setAttribute('transform', `rotate(${heading})`);
                g.appendChild(contrail);
            }
            
            g.appendChild(path);
            
            // Add label for aircraft type and altitude
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.textContent = `${aircraft.name} - ${Math.round(altitude)}ft`;
            text.setAttribute('x', visualSize * 3);
            text.setAttribute('y', '0');
            text.setAttribute('fill', 'rgba(0, 230, 255, 0.7)');
            text.setAttribute('font-size', `${Math.max(8, visualSize/1.5)}px`);
            text.setAttribute('font-family', 'monospace');
            g.appendChild(text);
            
            svg.appendChild(g);
        }
    }

    // Initialize aircraft on load
    createAircraft();
    // Refresh aircraft positions every 45 seconds
    setInterval(createAircraft, 45000);

renderMLEngine(patterns, data);
      renderSignals(data.alerts);
      renderPredictions(data.intent_signals);
      renderStats(data);
      
      // Auto-refresh every 30 seconds
      setTimeout(render, 30000);
    }
    
    // Initialize
    render();
  </script>
  <script src="../assets/dunsonator-chat.js"></script>
<script src="../assets/enhance.js"></script>
</body>
</html>
